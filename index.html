<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f39c12">
    <title>Gestionale Impresa Edile Pro</title>
    
    <!-- Librerie Esterne -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #f39c12;
            --primary-dark: #e67e22;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .card-header h2 {
            color: var(--dark);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 12px;
            opacity: 0.8;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--light);
        }

        th {
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .modal-header h2 {
            color: var(--dark);
            font-size: 22px;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 999;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            cursor: pointer;
            color: var(--gray);
            text-decoration: none;
            transition: color 0.3s;
            font-size: 12px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning);
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: #856404;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        .badge-secondary {
            background: var(--gray);
            color: white;
        }

        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        #scanner-video {
            width: 100%;
            border-radius: 10px;
            display: block;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid var(--primary);
            border-radius: 10px;
            pointer-events: none;
        }

        .qr-result {
            margin-top: 15px;
            padding: 15px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid var(--light);
            border-radius: 25px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .hidden {
            display: none !important;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
            z-index: 998;
            transition: all 0.3s;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);
        }

        .component-item {
            background: var(--light);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .component-info {
            flex: 1;
        }

        .component-actions {
            display: flex;
            gap: 5px;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            background: var(--light);
            color: var(--dark);
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 18px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card .value {
                font-size: 24px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }

        .qr-label-preview {
            border: 2px dashed var(--gray);
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 10px;
        }

        .qr-code-display {
            margin: 20px 0;
        }

        #qr-display {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dropbox-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: var(--light);
            border-radius: 20px;
            font-size: 13px;
        }

        .dropbox-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .dropbox-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="container">
        <div class="header">
            <h1>🏗️ Gestionale Pro</h1>
            <div class="header-actions">
                <div class="dropbox-status disconnected" id="google-drive-status">
                    <span class="status-indicator"></span>
                    <span id="google-drive-status-text">Google Drive</span>
                </div>
                <button class="btn btn-icon btn-secondary" onclick="showGoogleDriveConfig()" title="Guida Google Drive">
                    ❓
                </button>
                <button class="btn btn-icon btn-primary" onclick="showScanner()" title="Scansiona QR">
                    📷
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="container" id="main-content">
        <!-- Dashboard will be inserted here -->
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickActions()" id="fab-button">
        ➕
    </button>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" onclick="showView('dashboard'); return false;">
            <span class="nav-icon">🏠</span>
            <span>Dashboard</span>
        </a>
        <a href="#" class="nav-item" onclick="showView('equipment'); return false;">
            <span class="nav-icon">📦</span>
            <span>Attrezzature</span>
        </a>
        <a href="#" class="nav-item" onclick="showView('vehicles'); return false;">
            <span class="nav-icon">🚗</span>
            <span>Mezzi</span>
        </a>
        <a href="#" class="nav-item" onclick="showView('sites'); return false;">
            <span class="nav-icon">🏗️</span>
            <span>Cantieri</span>
        </a>
        <a href="#" class="nav-item" onclick="showView('workers'); return false;">
            <span class="nav-icon">👷</span>
            <span>Dipendenti</span>
        </a>
    </div>

    <!-- Modals -->
    <!-- Scanner Modal -->
    <div id="scanner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📷 Scanner QR</h2>
                <button class="close-modal" onclick="closeScanner()">×</button>
            </div>
            <div id="scanner-container">
                <video id="scanner-video" playsinline></video>
                <div class="scanner-overlay"></div>
            </div>
            <canvas id="scanner-canvas" class="hidden"></canvas>
            <div id="qr-result" class="qr-result hidden"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="closeScanner()">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE GOOGLE DRIVE
        // ============================================
        // Credenziali configurate per: Gestionale Iazzetta
        const GOOGLE_CLIENT_ID = '564684614843-tttcbv3hg324p20gc15jhl6vhe8le5h3.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyCDNCyFop2AfZGoP3ocMp9-EmeVdcXyN7U';
        const GOOGLE_DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        // ============================================

        // Data Structure
        const AppData = {
            equipment: [],
            vehicles: [],
            sites: [],
            workers: [],
            movements: [],
            alerts: [],
            settings: {
                companyName: 'La Mia Impresa',
                companyLogo: '',
                unitMeasures: ['pz', 'kg', 'm', 'l', 'm²', 'm³', 'sacco', 'rotolo', 'bancale', 'cartone'],
                categories: {
                    equipment: ['Utensili Manuali', 'Utensili Elettrici', 'Macchine', 'Sicurezza', 'Materiali'],
                    vehicles: ['Autocarro', 'Furgone', 'Escavatore', 'Gru', 'Altro'],
                    sites: ['Ristrutturazione', 'Nuova Costruzione', 'Manutenzione', 'Demolizione']
                }
            }
        };

        // Generate unique ID
        function generateId(prefix = 'ID') {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000);
            return `${prefix}-${timestamp}-${random}`;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount || 0);
        }

        // Format date
        function formatDate(date) {
            if (!date) return '-';
            return new Date(date).toLocaleDateString('it-IT');
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('appData', JSON.stringify(AppData));
                console.log('✅ Dati salvati in locale');
                
                // Sync to Dropbox if connected
                if (isDropboxConnected()) {
                    syncToDropbox();
                }
            } catch (error) {
                console.error('❌ Errore salvataggio:', error);
                showNotification('Errore salvataggio dati', 'error');
            }
        }

        // Load data from localStorage
        function loadData() {
            try {
                const saved = localStorage.getItem('appData');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(AppData, data);
                    console.log('✅ Dati caricati');
                }
            } catch (error) {
                console.error('❌ Errore caricamento:', error);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span>${type === 'success' ? '✅' : '⚠️'}</span>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('main-content');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Current view state
        let currentView = 'dashboard';

        // Show view
        function showView(view) {
            currentView = view;
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Render view
            switch(view) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'equipment':
                    renderEquipmentList();
                    break;
                case 'vehicles':
                    renderVehiclesList();
                    break;
                case 'sites':
                    renderSitesList();
                    break;
                case 'workers':
                    renderWorkersList();
                    break;
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function renderDashboard() {
            const stats = calculateStats();
            const alerts = getActiveAlerts();
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>📊 Dashboard</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-secondary" onclick="printInventoryReport('complete')">
                                🖨️ Report Completo
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="refreshDashboard()">
                                🔄 Aggiorna
                            </button>
                        </div>
                    </div>
                    
                    ${alerts.length > 0 ? `
                        <div class="alert alert-warning">
                            <span>⚠️</span>
                            <span><strong>${alerts.length} Alert</strong> richiedono attenzione</span>
                        </div>
                    ` : ''}
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                            <h3>Attrezzature</h3>
                            <div class="value">${stats.equipment.total}</div>
                            <div class="label">${stats.equipment.available} disponibili</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                            <h3>Mezzi</h3>
                            <div class="value">${stats.vehicles.total}</div>
                            <div class="label">${stats.vehicles.available} disponibili</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                            <h3>Cantieri</h3>
                            <div class="value">${stats.sites.active}</div>
                            <div class="label">${stats.sites.total} totali</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                            <h3>Dipendenti</h3>
                            <div class="value">${stats.workers.total}</div>
                            <div class="label">${stats.workers.active} attivi</div>
                        </div>
                    </div>
                </div>
                
                ${renderRecentMovements()}
                ${renderUpcomingAlerts()}
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        function calculateStats() {
            return {
                equipment: {
                    total: AppData.equipment.length,
                    available: AppData.equipment.filter(e => e.status === 'available').length,
                    inUse: AppData.equipment.filter(e => e.status === 'in_use').length,
                    maintenance: AppData.equipment.filter(e => e.status === 'maintenance').length
                },
                vehicles: {
                    total: AppData.vehicles.length,
                    available: AppData.vehicles.filter(v => v.status === 'available').length,
                    inUse: AppData.vehicles.filter(v => v.status === 'in_use').length
                },
                sites: {
                    total: AppData.sites.length,
                    active: AppData.sites.filter(s => s.status === 'active').length,
                    completed: AppData.sites.filter(s => s.status === 'completed').length
                },
                workers: {
                    total: AppData.workers.length,
                    active: AppData.workers.filter(w => w.status === 'active').length
                }
            };
        }

        function getActiveAlerts() {
            const alerts = [];
            const now = new Date();
            
            // Check equipment maintenance
            AppData.equipment.forEach(eq => {
                if (eq.nextMaintenance) {
                    const maintenanceDate = new Date(eq.nextMaintenance);
                    const daysUntil = Math.ceil((maintenanceDate - now) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 7 && daysUntil >= 0) {
                        alerts.push({
                            type: 'maintenance',
                            message: `Manutenzione ${eq.name} tra ${daysUntil} giorni`,
                            priority: daysUntil <= 3 ? 'high' : 'medium',
                            item: eq
                        });
                    }
                }
            });
            
            // Check vehicle revisions
            AppData.vehicles.forEach(v => {
                if (v.revisionDate) {
                    const revisionDate = new Date(v.revisionDate);
                    const daysUntil = Math.ceil((revisionDate - now) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 30 && daysUntil >= 0) {
                        alerts.push({
                            type: 'revision',
                            message: `Revisione ${v.plate} tra ${daysUntil} giorni`,
                            priority: daysUntil <= 15 ? 'high' : 'medium',
                            item: v
                        });
                    }
                }
            });
            
            return alerts;
        }

        function renderRecentMovements() {
            const recentMovements = AppData.movements.slice(-5).reverse();
            
            if (recentMovements.length === 0) {
                return `
                    <div class="card">
                        <div class="card-header">
                            <h2>📦 Movimenti Recenti</h2>
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <p>Nessun movimento registrato</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h2>📦 Movimenti Recenti</h2>
                        <button class="btn btn-sm btn-primary" onclick="showView('movements')">
                            Vedi Tutti
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Oggetto</th>
                                    <th>Da/A</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentMovements.map(m => `
                                    <tr>
                                        <td>${formatDate(m.date)}</td>
                                        <td>
                                            <span class="badge badge-${m.type === 'delivery' ? 'success' : 'warning'}">
                                                ${m.type === 'delivery' ? '📤 Consegna' : '📥 Rientro'}
                                            </span>
                                        </td>
                                        <td>${m.itemName}</td>
                                        <td>${m.from} → ${m.to}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderUpcomingAlerts() {
            const alerts = getActiveAlerts();
            
            if (alerts.length === 0) {
                return '';
            }
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h2>⚠️ Alert (${alerts.length})</h2>
                    </div>
                    <div>
                        ${alerts.map(alert => `
                            <div class="alert alert-${alert.priority === 'high' ? 'danger' : 'warning'}">
                                <span>${alert.priority === 'high' ? '🚨' : '⚠️'}</span>
                                <span>${alert.message}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function refreshDashboard() {
            showNotification('Dashboard aggiornata');
            renderDashboard();
        }

        // ============================================
        // EQUIPMENT MANAGEMENT
        // ============================================
        function renderEquipmentList() {
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>📦 Attrezzature</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="printInventoryReport('equipment')">
                                🖨️ Stampa Inventario
                            </button>
                            <button class="btn btn-primary" onclick="showAddEquipmentModal()">
                                ➕ Aggiungi
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" placeholder="Cerca attrezzatura..." onkeyup="filterEquipment(this.value)">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    ${AppData.equipment.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <p>Nessuna attrezzatura inserita</p>
                            <button class="btn btn-primary" onclick="showAddEquipmentModal()">
                                ➕ Aggiungi Prima Attrezzatura
                            </button>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table id="equipment-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Stato</th>
                                        <th>Posizione</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${AppData.equipment.map(eq => `
                                        <tr>
                                            <td>
                                                <strong>${eq.name}</strong>
                                                ${eq.requiresWarning ? '<span class="badge badge-danger" style="margin-left: 5px;">⚠️ ATTENZIONE</span>' : ''}
                                                <br>
                                                <small>${eq.brand || ''} ${eq.model || ''}</small>
                                            </td>
                                            <td>${eq.category}</td>
                                            <td>
                                                <span class="badge badge-${getStatusColor(eq.status)}">
                                                    ${getStatusText(eq.status)}
                                                </span>
                                            </td>
                                            <td>${eq.location || 'Magazzino'}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-secondary" onclick="viewEquipmentDetails('${eq.id}')">
                                                        👁️ Vedi
                                                    </button>
                                                    <button class="btn btn-sm btn-primary" onclick="printQRLabel('${eq.id}')">
                                                        🖨️ QR
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        function getStatusColor(status) {
            const colors = {
                'available': 'success',
                'in_use': 'warning',
                'maintenance': 'danger',
                'out_of_service': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'available': '✅ Disponibile',
                'in_use': '🔄 In Uso',
                'maintenance': '🔧 Manutenzione',
                'out_of_service': '❌ Fuori Servizio'
            };
            return texts[status] || status;
        }

        function filterEquipment(query) {
            const table = document.getElementById('equipment-table');
            if (!table) return;
            
            const rows = table.getElementsByTagName('tr');
            query = query.toLowerCase();
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            }
        }

        function showAddEquipmentModal() {
            const modalHtml = `
                <div id="add-equipment-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>➕ Nuova Attrezzatura</h2>
                            <button class="close-modal" onclick="closeModal('add-equipment-modal')">×</button>
                        </div>
                        <form onsubmit="saveEquipment(event)">
                            <div class="form-group">
                                <label>Nome *</label>
                                <input type="text" id="eq-name" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Categoria *</label>
                                    <select id="eq-category" required>
                                        <option value="">Seleziona...</option>
                                        ${AppData.settings.categories.equipment.map(cat => `
                                            <option value="${cat}">${cat}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <select id="eq-type">
                                        <option value="single">Singola</option>
                                        <option value="kit">Kit/Set Composto</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Marca</label>
                                    <input type="text" id="eq-brand">
                                </div>
                                <div class="form-group">
                                    <label>Modello</label>
                                    <input type="text" id="eq-model">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Costo (€)</label>
                                    <input type="number" id="eq-cost" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Fornitore</label>
                                    <input type="text" id="eq-supplier">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Data Acquisto</label>
                                    <input type="date" id="eq-purchase-date">
                                </div>
                                <div class="form-group">
                                    <label>Scadenza Garanzia</label>
                                    <input type="date" id="eq-warranty">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Manutenzione ogni (giorni)</label>
                                <input type="number" id="eq-maintenance-days" placeholder="es. 90">
                            </div>
                            
                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="eq-notes"></textarea>
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 20px;">
                                <span>⚠️</span>
                                <span><strong>Attrezzatura Speciale / Pericolosa?</strong></span>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="eq-requires-warning" style="width: 20px; height: 20px;">
                                    <span>Richiede avviso prima dell'utilizzo</span>
                                </label>
                                <small style="color: #666; margin-left: 30px;">
                                    Attiva per attrezzature pericolose o che richiedono particolari attenzioni
                                </small>
                            </div>
                            
                            <div class="form-group" id="warning-message-group" style="display: none;">
                                <label>⚠️ Messaggio di Avviso *</label>
                                <textarea id="eq-warning-message" placeholder="Es: ATTENZIONE - Utilizzo riservato a personale certificato. Indossare sempre DPI completi. Verificare integrità cavi e connessioni prima dell'uso."></textarea>
                                <small style="color: #666;">
                                    Questo messaggio verrà mostrato ogni volta che qualcuno tenta di movimentare questa attrezzatura
                                </small>
                            </div>
                            
                            <script>
                                document.getElementById('eq-requires-warning').addEventListener('change', function() {
                                    const messageGroup = document.getElementById('warning-message-group');
                                    const messageField = document.getElementById('eq-warning-message');
                                    if (this.checked) {
                                        messageGroup.style.display = 'block';
                                        messageField.required = true;
                                    } else {
                                        messageGroup.style.display = 'none';
                                        messageField.required = false;
                                        messageField.value = '';
                                    }
                                });
                            </script>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('add-equipment-modal')">
                                    Annulla
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    💾 Salva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveEquipment(event) {
            event.preventDefault();
            
            const equipment = {
                id: generateId('EQ'),
                name: document.getElementById('eq-name').value,
                category: document.getElementById('eq-category').value,
                type: document.getElementById('eq-type').value,
                brand: document.getElementById('eq-brand').value,
                model: document.getElementById('eq-model').value,
                cost: parseFloat(document.getElementById('eq-cost').value) || 0,
                supplier: document.getElementById('eq-supplier').value,
                purchaseDate: document.getElementById('eq-purchase-date').value,
                warranty: document.getElementById('eq-warranty').value,
                maintenanceDays: parseInt(document.getElementById('eq-maintenance-days').value) || 0,
                notes: document.getElementById('eq-notes').value,
                requiresWarning: document.getElementById('eq-requires-warning').checked,
                warningMessage: document.getElementById('eq-warning-message').value,
                warningAcknowledgments: [], // Log of who acknowledged warnings
                status: 'available',
                location: 'Magazzino Centrale',
                createdAt: new Date().toISOString(),
                qrCode: null,
                photos: [],
                components: []
            };
            
            // Calculate next maintenance if applicable
            if (equipment.maintenanceDays > 0 && equipment.purchaseDate) {
                const purchaseDate = new Date(equipment.purchaseDate);
                const nextMaintenance = new Date(purchaseDate);
                nextMaintenance.setDate(nextMaintenance.getDate() + equipment.maintenanceDays);
                equipment.nextMaintenance = nextMaintenance.toISOString().split('T')[0];
            }
            
            AppData.equipment.push(equipment);
            saveData();
            
            closeModal('add-equipment-modal');
            showNotification('✅ Attrezzatura aggiunta con successo!');
            
            // Show QR print option
            setTimeout(() => {
                if (confirm('Vuoi stampare subito l\'etichetta QR?')) {
                    printQRLabel(equipment.id);
                } else {
                    renderEquipmentList();
                }
            }, 500);
        }

        // ============================================
        // QR CODE GENERATION & LABELS
        // ============================================
        function generateQRCode(data) {
            return new Promise((resolve, reject) => {
                try {
                    // Create temporary container
                    const container = document.createElement('div');
                    container.id = 'qr-temp-' + Date.now();
                    container.style.cssText = 'position: fixed; left: -9999px; top: -9999px;';
                    document.body.appendChild(container);
                    
                    // Check if QRCode library is loaded
                    if (typeof QRCode === 'undefined') {
                        console.error('QRCode library not loaded');
                        reject('QRCode library not loaded');
                        return;
                    }
                    
                    // Generate QR code
                    const qr = new QRCode(container, {
                        text: JSON.stringify(data),
                        width: 256,
                        height: 256,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    
                    // Wait for QR to render
                    setTimeout(() => {
                        try {
                            const canvas = container.querySelector('canvas');
                            const img = container.querySelector('img');
                            
                            let qrDataUrl;
                            if (canvas) {
                                // Prefer canvas
                                qrDataUrl = canvas.toDataURL('image/png');
                            } else if (img && img.src) {
                                // Fallback to img
                                qrDataUrl = img.src;
                            } else {
                                console.error('No QR code generated');
                                reject('No QR code generated');
                                return;
                            }
                            
                            // Cleanup
                            document.body.removeChild(container);
                            
                            // Verify QR code is not empty
                            if (qrDataUrl && qrDataUrl.length > 100) {
                                resolve(qrDataUrl);
                            } else {
                                console.error('QR code data URL is empty or invalid');
                                reject('Invalid QR code');
                            }
                        } catch (err) {
                            console.error('Error extracting QR code:', err);
                            reject(err);
                        }
                    }, 300); // Increased timeout for reliability
                } catch (err) {
                    console.error('Error generating QR code:', err);
                    reject(err);
                }
            });
        }

        async function printQRLabel(itemId) {
            const item = AppData.equipment.find(e => e.id === itemId) || 
                        AppData.vehicles.find(v => v.id === itemId);
            
            if (!item) {
                showNotification('Elemento non trovato', 'error');
                return;
            }
            
            try {
                showNotification('Generazione QR code...', 'success');
                
                // Generate QR if not exists
                if (!item.qrCode) {
                    const qrData = {
                        id: item.id,
                        type: item.plate ? 'vehicle' : 'equipment',
                        name: item.name || item.plate
                    };
                    
                    item.qrCode = await generateQRCode(qrData);
                    saveData();
                    
                    console.log('QR Code generated successfully:', item.qrCode.substring(0, 50) + '...');
                }
                
                // Verify QR code exists and is valid
                if (!item.qrCode || item.qrCode.length < 100) {
                    throw new Error('QR code non valido');
                }
                
                showNotification('QR code generato!', 'success');
                
                // Create label HTML
                const labelHtml = `
                    <div style="width: 5cm; height: 5cm; padding: 10px; border: 2px solid #000; text-align: center; font-family: Arial;">
                        <img src="${item.qrCode}" style="width: 3cm; height: 3cm; display: block; margin: 0 auto;">
                        <div style="font-size: 12px; font-weight: bold; margin-top: 5px;">
                            ${item.name || item.plate}
                        </div>
                    <div style="font-size: 10px; color: #666;">
                        ${item.brand || ''} ${item.model || ''}
                    </div>
                    <div style="font-size: 9px; margin-top: 3px;">
                        ${item.id}
                    </div>
                </div>
            `;
            
            // Show preview modal
            const modalHtml = `
                <div id="qr-label-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>🖨️ Etichetta QR</h2>
                            <button class="close-modal" onclick="closeModal('qr-label-modal')">×</button>
                        </div>
                        <div class="qr-label-preview">
                            ${labelHtml}
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('qr-label-modal')">
                                Chiudi
                            </button>
                            <button class="btn btn-primary" onclick="downloadQRLabel('${item.id}')">
                                📥 Scarica PDF
                            </button>
                            <button class="btn btn-success" onclick="window.print()">
                                🖨️ Stampa
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Errore generazione QR:', error);
                showNotification('❌ Errore generazione QR code: ' + error.message, 'error');
            }
        }

        function downloadQRLabel(itemId) {
            showNotification('PDF in generazione...', 'success');
            // In production, use jsPDF to generate actual PDF
            // For now, just show success message
            setTimeout(() => {
                showNotification('✅ PDF pronto per il download!');
                closeModal('qr-label-modal');
            }, 1000);
        }

        // ============================================
        // INVENTORY REPORTS
        // ============================================
        
        function printInventoryReport(type) {
            showNotification('Generazione report in corso...', 'success');
            
            let title, items, columns;
            
            if (type === 'equipment') {
                title = 'Inventario Attrezzature';
                items = AppData.equipment;
                columns = ['Nome', 'Categoria', 'Marca/Modello', 'Stato', 'Posizione', 'Costo'];
            } else if (type === 'vehicles') {
                title = 'Inventario Mezzi';
                items = AppData.vehicles;
                columns = ['Targa', 'Tipo', 'Marca/Modello', 'Stato', 'Scadenze', 'Costo'];
            } else if (type === 'complete') {
                printCompleteInventory();
                return;
            }
            
            if (items.length === 0) {
                showNotification('❌ Nessun elemento da stampare', 'error');
                return;
            }
            
            // Create print window
            const printWindow = window.open('', '_blank');
            
            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <style>
                        @media print {
                            @page { margin: 1.5cm; }
                            body { margin: 0; }
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #f39c12;
                            padding-bottom: 20px;
                        }
                        
                        .header h1 {
                            color: #f39c12;
                            margin: 0 0 10px 0;
                        }
                        
                        .header .date {
                            color: #666;
                            font-size: 14px;
                        }
                        
                        .summary {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 30px;
                            display: flex;
                            justify-content: space-around;
                        }
                        
                        .summary-item {
                            text-align: center;
                        }
                        
                        .summary-item .value {
                            font-size: 32px;
                            font-weight: bold;
                            color: #f39c12;
                        }
                        
                        .summary-item .label {
                            color: #666;
                            font-size: 14px;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        
                        th {
                            background: #f39c12;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                        }
                        
                        td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        tr:hover {
                            background: #f8f9fa;
                        }
                        
                        .badge {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        
                        .badge-success { background: #2ecc71; color: white; }
                        .badge-warning { background: #f1c40f; color: #333; }
                        .badge-danger { background: #e74c3c; color: white; }
                        
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            color: #666;
                            font-size: 12px;
                            border-top: 1px solid #ddd;
                            padding-top: 20px;
                        }
                        
                        .print-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #f39c12;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                        }
                        
                        @media print {
                            .print-button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-button" onclick="window.print()">🖨️ Stampa</button>
                    
                    <div class="header">
                        <h1>📋 ${title}</h1>
                        <div class="date">Generato il: ${new Date().toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</div>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <div class="value">${items.length}</div>
                            <div class="label">Totale</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${items.filter(i => i.status === 'available').length}</div>
                            <div class="label">Disponibili</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${items.filter(i => i.status === 'in_use').length}</div>
                            <div class="label">In Uso</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${items.filter(i => i.status === 'maintenance').length}</div>
                            <div class="label">Manutenzione</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => {
                                if (type === 'equipment') {
                                    return `
                                        <tr>
                                            <td><strong>${item.name}</strong><br><small>${item.id}</small></td>
                                            <td>${item.category}</td>
                                            <td>${item.brand || '-'} ${item.model || ''}</td>
                                            <td><span class="badge badge-${getStatusColor(item.status)}">${getStatusText(item.status)}</span></td>
                                            <td>${item.location || 'Magazzino'}</td>
                                            <td>${formatCurrency(item.cost)}</td>
                                        </tr>
                                    `;
                                } else {
                                    return `
                                        <tr>
                                            <td><strong>${item.plate}</strong></td>
                                            <td>${item.type}</td>
                                            <td>${item.brand} ${item.model}</td>
                                            <td><span class="badge badge-${getStatusColor(item.status)}">${getStatusText(item.status)}</span></td>
                                            <td>
                                                Rev: ${formatDate(item.revisionDate)}<br>
                                                Ass: ${formatDate(item.insuranceDate)}
                                            </td>
                                            <td>${formatCurrency(item.cost)}</td>
                                        </tr>
                                    `;
                                }
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>Gestionale Impresa Edile Pro</strong></p>
                        <p>Report generato automaticamente - Tutti i diritti riservati</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printHtml);
            printWindow.document.close();
            
            showNotification('✅ Report pronto per la stampa!', 'success');
        }
        
        function printCompleteInventory() {
            showNotification('Generazione report completo...', 'success');
            
            const totalEquipment = AppData.equipment.length;
            const totalVehicles = AppData.vehicles.length;
            const totalSites = AppData.sites.length;
            
            const totalValue = AppData.equipment.reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0) +
                             AppData.vehicles.reduce((sum, v) => sum + (parseFloat(v.cost) || 0), 0);
            
            const printWindow = window.open('', '_blank');
            
            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Report Completo Inventario</title>
                    <style>
                        @media print {
                            @page { margin: 1.5cm; }
                            body { margin: 0; }
                            .page-break { page-break-before: always; }
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #f39c12;
                            padding-bottom: 20px;
                        }
                        
                        h1 { color: #f39c12; margin: 0 0 10px 0; }
                        h2 { color: #2c3e50; margin-top: 30px; border-bottom: 2px solid #f39c12; padding-bottom: 10px; }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 40px;
                        }
                        
                        .summary-card {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 12px;
                            text-align: center;
                        }
                        
                        .summary-card .value {
                            font-size: 36px;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        
                        .summary-card .label {
                            font-size: 14px;
                            opacity: 0.9;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        
                        th {
                            background: #f39c12;
                            color: white;
                            padding: 12px;
                            text-align: left;
                        }
                        
                        td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .badge {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        
                        .badge-success { background: #2ecc71; color: white; }
                        .badge-warning { background: #f1c40f; color: #333; }
                        .badge-danger { background: #e74c3c; color: white; }
                        
                        .print-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #f39c12;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                        }
                        
                        @media print {
                            .print-button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-button" onclick="window.print()">🖨️ Stampa</button>
                    
                    <div class="header">
                        <h1>📊 Report Completo Inventario</h1>
                        <div class="date">Generato il: ${new Date().toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</div>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="value">${totalEquipment}</div>
                            <div class="label">📦 Attrezzature</div>
                        </div>
                        <div class="summary-card">
                            <div class="value">${totalVehicles}</div>
                            <div class="label">🚗 Mezzi</div>
                        </div>
                        <div class="summary-card">
                            <div class="value">${totalSites}</div>
                            <div class="label">🏗️ Cantieri</div>
                        </div>
                        <div class="summary-card">
                            <div class="value">${formatCurrency(totalValue)}</div>
                            <div class="label">💰 Valore Totale</div>
                        </div>
                    </div>
                    
                    ${totalEquipment > 0 ? `
                        <h2>📦 Attrezzature (${totalEquipment})</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Marca/Modello</th>
                                    <th>Stato</th>
                                    <th>Posizione</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${AppData.equipment.map(eq => `
                                    <tr>
                                        <td><strong>${eq.name}</strong><br><small>${eq.id}</small></td>
                                        <td>${eq.category}</td>
                                        <td>${eq.brand || '-'} ${eq.model || ''}</td>
                                        <td><span class="badge badge-${getStatusColor(eq.status)}">${getStatusText(eq.status)}</span></td>
                                        <td>${eq.location || 'Magazzino'}</td>
                                        <td>${formatCurrency(eq.cost)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    ${totalVehicles > 0 ? `
                        <div class="page-break"></div>
                        <h2>🚗 Mezzi (${totalVehicles})</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Targa</th>
                                    <th>Tipo</th>
                                    <th>Marca/Modello</th>
                                    <th>Stato</th>
                                    <th>Scadenze</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${AppData.vehicles.map(v => `
                                    <tr>
                                        <td><strong>${v.plate}</strong></td>
                                        <td>${v.type}</td>
                                        <td>${v.brand} ${v.model}</td>
                                        <td><span class="badge badge-${getStatusColor(v.status)}">${getStatusText(v.status)}</span></td>
                                        <td>
                                            Rev: ${formatDate(v.revisionDate)}<br>
                                            Ass: ${formatDate(v.insuranceDate)}
                                        </td>
                                        <td>${formatCurrency(v.cost)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <div class="footer" style="margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px;">
                        <p><strong>Gestionale Impresa Edile Pro</strong></p>
                        <p>Report generato automaticamente - Tutti i diritti riservati</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printHtml);
            printWindow.document.close();
            
            showNotification('✅ Report completo pronto!', 'success');
        }

        // ============================================
        // QR SCANNER
        // ============================================
        let scannerStream = null;
        let scannerInterval = null;

        function showScanner() {
            const modal = document.getElementById('scanner-modal');
            modal.classList.add('active');
            startScanner();
        }

        function closeScanner() {
            stopScanner();
            const modal = document.getElementById('scanner-modal');
            modal.classList.remove('active');
        }

        async function startScanner() {
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('scanner-canvas');
            const ctx = canvas.getContext('2d');
            
            try {
                scannerStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                video.srcObject = scannerStream;
                video.play();
                
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    scannerInterval = setInterval(() => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            
                            if (code) {
                                handleQRCodeScanned(code.data);
                            }
                        }
                    }, 300);
                });
                
            } catch (error) {
                console.error('Camera error:', error);
                showNotification('Impossibile accedere alla camera', 'error');
            }
        }

        function stopScanner() {
            if (scannerInterval) {
                clearInterval(scannerInterval);
                scannerInterval = null;
            }
            
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            const video = document.getElementById('scanner-video');
            video.srcObject = null;
        }

        function handleQRCodeScanned(data) {
            stopScanner();
            
            try {
                const qrData = JSON.parse(data);
                const resultDiv = document.getElementById('qr-result');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `✅ ${qrData.type === 'vehicle' ? 'Mezzo' : 'Attrezzatura'} riconosciuto: <strong>${qrData.name}</strong>`;
                
                setTimeout(() => {
                    closeScanner();
                    if (qrData.type === 'vehicle') {
                        viewVehicleDetails(qrData.id);
                    } else {
                        viewEquipmentDetails(qrData.id);
                    }
                }, 1500);
                
            } catch (error) {
                showNotification('QR Code non valido', 'error');
            }
        }

        // ============================================
        // DETAIL VIEWS
        // ============================================
        function viewEquipmentDetails(id) {
            const equipment = AppData.equipment.find(e => e.id === id);
            if (!equipment) {
                showNotification('Attrezzatura non trovata', 'error');
                return;
            }
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>📦 ${equipment.name}</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="printQRLabel('${equipment.id}')">
                                🖨️ QR
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="renderEquipmentList()">
                                ← Indietro
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Categoria:</strong><br>
                            ${equipment.category}
                        </div>
                        <div>
                            <strong>Marca/Modello:</strong><br>
                            ${equipment.brand || '-'} ${equipment.model || '-'}
                        </div>
                        <div>
                            <strong>Stato:</strong><br>
                            <span class="badge badge-${getStatusColor(equipment.status)}">
                                ${getStatusText(equipment.status)}
                            </span>
                        </div>
                        <div>
                            <strong>Posizione:</strong><br>
                            ${equipment.location || 'Magazzino'}
                        </div>
                        <div>
                            <strong>Costo:</strong><br>
                            ${formatCurrency(equipment.cost)}
                        </div>
                        <div>
                            <strong>Fornitore:</strong><br>
                            ${equipment.supplier || '-'}
                        </div>
                        <div>
                            <strong>Data Acquisto:</strong><br>
                            ${formatDate(equipment.purchaseDate)}
                        </div>
                        <div>
                            <strong>Garanzia:</strong><br>
                            ${formatDate(equipment.warranty)}
                        </div>
                    </div>
                    
                    ${equipment.requiresWarning && equipment.warningMessage ? `
                        <div class="alert alert-danger" style="margin-top: 20px; border: 3px solid #e74c3c;">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <span style="font-size: 36px;">⚠️</span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 18px;">AVVISO DI SICUREZZA</strong>
                                    <p style="margin: 10px 0 0 0; white-space: pre-wrap; line-height: 1.6;">
${equipment.warningMessage}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        ${equipment.warningAcknowledgments && equipment.warningAcknowledgments.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <strong>📋 Storico Conferme Avviso:</strong>
                                <div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                                    ${equipment.warningAcknowledgments.slice(-5).reverse().map(ack => `
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 14px;">
                                            <strong>${ack.acknowledger}</strong> - ${new Date(ack.timestamp).toLocaleString('it-IT')}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}
                    
                    ${equipment.nextMaintenance ? `
                        <div class="alert alert-warning" style="margin-top: 20px;">
                            <span>🔧</span>
                            <span>Prossima manutenzione: ${formatDate(equipment.nextMaintenance)}</span>
                        </div>
                    ` : ''}
                    
                    ${equipment.notes ? `
                        <div style="margin-top: 20px;">
                            <strong>Note:</strong><br>
                            <p>${equipment.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="createMovement('${equipment.id}', 'equipment')">
                            📤 Nuovo Movimento
                        </button>
                        <button class="btn btn-primary" onclick="editEquipment('${equipment.id}')">
                            ✏️ Modifica
                        </button>
                        <button class="btn btn-danger" onclick="deleteEquipment('${equipment.id}')">
                            🗑️ Elimina
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        // ============================================
        // VEHICLES
        // ============================================
        function renderVehiclesList() {
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>🚗 Mezzi</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="printInventoryReport('vehicles')">
                                🖨️ Stampa Inventario
                            </button>
                            <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                ➕ Aggiungi
                            </button>
                        </div>
                    </div>
                    
                    ${AppData.vehicles.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">🚗</div>
                            <p>Nessun mezzo inserito</p>
                            <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                ➕ Aggiungi Primo Mezzo
                            </button>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Targa</th>
                                        <th>Tipo</th>
                                        <th>Marca/Modello</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${AppData.vehicles.map(v => `
                                        <tr>
                                            <td><strong>${v.plate}</strong></td>
                                            <td>${v.type}</td>
                                            <td>${v.brand} ${v.model}</td>
                                            <td>
                                                <span class="badge badge-${getStatusColor(v.status)}">
                                                    ${getStatusText(v.status)}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-secondary" onclick="viewVehicleDetails('${v.id}')">
                                                        👁️ Vedi
                                                    </button>
                                                    <button class="btn btn-sm btn-primary" onclick="printQRLabel('${v.id}')">
                                                        🖨️ QR
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        function showAddVehicleModal() {
            const modalHtml = `
                <div id="add-vehicle-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>➕ Nuovo Mezzo</h2>
                            <button class="close-modal" onclick="closeModal('add-vehicle-modal')">×</button>
                        </div>
                        <form onsubmit="saveVehicle(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Targa *</label>
                                    <input type="text" id="v-plate" required>
                                </div>
                                <div class="form-group">
                                    <label>Tipo *</label>
                                    <select id="v-type" required>
                                        <option value="">Seleziona...</option>
                                        ${AppData.settings.categories.vehicles.map(type => `
                                            <option value="${type}">${type}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Marca *</label>
                                    <input type="text" id="v-brand" required>
                                </div>
                                <div class="form-group">
                                    <label>Modello</label>
                                    <input type="text" id="v-model">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Anno</label>
                                    <input type="number" id="v-year" min="1950" max="2030">
                                </div>
                                <div class="form-group">
                                    <label>Chilometri Attuali</label>
                                    <input type="number" id="v-km">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Scadenza Revisione</label>
                                    <input type="date" id="v-revision">
                                </div>
                                <div class="form-group">
                                    <label>Scadenza Assicurazione</label>
                                    <input type="date" id="v-insurance">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Costo Acquisto (€)</label>
                                    <input type="number" id="v-cost" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Fornitore</label>
                                    <input type="text" id="v-supplier">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="v-notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('add-vehicle-modal')">
                                    Annulla
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    💾 Salva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveVehicle(event) {
            event.preventDefault();
            
            const vehicle = {
                id: generateId('VEH'),
                plate: document.getElementById('v-plate').value,
                type: document.getElementById('v-type').value,
                brand: document.getElementById('v-brand').value,
                model: document.getElementById('v-model').value,
                year: parseInt(document.getElementById('v-year').value) || null,
                km: parseInt(document.getElementById('v-km').value) || 0,
                revisionDate: document.getElementById('v-revision').value,
                insuranceDate: document.getElementById('v-insurance').value,
                cost: parseFloat(document.getElementById('v-cost').value) || 0,
                supplier: document.getElementById('v-supplier').value,
                notes: document.getElementById('v-notes').value,
                status: 'available',
                location: 'Sede',
                createdAt: new Date().toISOString(),
                qrCode: null,
                photos: []
            };
            
            AppData.vehicles.push(vehicle);
            saveData();
            
            closeModal('add-vehicle-modal');
            showNotification('✅ Mezzo aggiunto con successo!');
            
            setTimeout(() => {
                if (confirm('Vuoi stampare subito l\'etichetta QR?')) {
                    printQRLabel(vehicle.id);
                } else {
                    renderVehiclesList();
                }
            }, 500);
        }

        function viewVehicleDetails(id) {
            const vehicle = AppData.vehicles.find(v => v.id === id);
            if (!vehicle) {
                showNotification('Mezzo non trovato', 'error');
                return;
            }
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>🚗 ${vehicle.plate}</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="printQRLabel('${vehicle.id}')">
                                🖨️ QR
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="renderVehiclesList()">
                                ← Indietro
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Tipo:</strong><br>
                            ${vehicle.type}
                        </div>
                        <div>
                            <strong>Marca/Modello:</strong><br>
                            ${vehicle.brand} ${vehicle.model}
                        </div>
                        <div>
                            <strong>Anno:</strong><br>
                            ${vehicle.year || '-'}
                        </div>
                        <div>
                            <strong>Chilometri:</strong><br>
                            ${vehicle.km.toLocaleString()} km
                        </div>
                        <div>
                            <strong>Revisione:</strong><br>
                            ${formatDate(vehicle.revisionDate)}
                        </div>
                        <div>
                            <strong>Assicurazione:</strong><br>
                            ${formatDate(vehicle.insuranceDate)}
                        </div>
                        <div>
                            <strong>Costo:</strong><br>
                            ${formatCurrency(vehicle.cost)}
                        </div>
                        <div>
                            <strong>Stato:</strong><br>
                            <span class="badge badge-${getStatusColor(vehicle.status)}">
                                ${getStatusText(vehicle.status)}
                            </span>
                        </div>
                    </div>
                    
                    ${vehicle.notes ? `
                        <div style="margin-top: 20px;">
                            <strong>Note:</strong><br>
                            <p>${vehicle.notes}</p>
                        </div>
                    ` : ''}
                    
                    ${vehicle.trips && vehicle.trips.length > 0 ? `
                        <div style="margin-top: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #f39c12; margin: 0;">📊 Storico Viaggi (${vehicle.trips.length})</h3>
                                <button class="btn btn-sm btn-secondary" onclick="printVehicleTripsReport('${vehicle.id}')">
                                    🖨️ Report Viaggi
                                </button>
                            </div>
                            
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${vehicle.trips.slice(-10).reverse().map(trip => `
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${trip.completed ? '#2ecc71' : '#f39c12'};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <div>
                                                <strong>${trip.from}</strong> → <strong>${trip.to}</strong>
                                                ${trip.completed ? '<span class="badge badge-success" style="margin-left: 10px;">✅ Completato</span>' : '<span class="badge badge-warning" style="margin-left: 10px;">🚗 In corso</span>'}
                                            </div>
                                            <button class="btn btn-sm btn-secondary" onclick="printTripSheet('${trip.id}', '${vehicle.id}')">
                                                🖨️
                                            </button>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px; color: #666;">
                                            <div>👤 ${trip.driver}</div>
                                            <div>📅 ${new Date(trip.startTime).toLocaleDateString('it-IT')}</div>
                                            <div>🛣️ ${trip.kmDifference} km</div>
                                            <div>⛽ ${trip.fuel} L</div>
                                            <div>💰 € ${trip.totalCost.toFixed(2)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <strong>📊 Statistiche Totali:</strong>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <div>
                                        🛣️ <strong>${vehicle.trips.reduce((sum, t) => sum + t.kmDifference, 0).toLocaleString()} km</strong>
                                        <div style="font-size: 12px; color: #666;">Totali percorsi</div>
                                    </div>
                                    <div>
                                        ⛽ <strong>${vehicle.trips.reduce((sum, t) => sum + t.fuel, 0).toFixed(1)} L</strong>
                                        <div style="font-size: 12px; color: #666;">Carburante totale</div>
                                    </div>
                                    <div>
                                        💰 <strong>€ ${vehicle.trips.reduce((sum, t) => sum + t.totalCost, 0).toFixed(2)}</strong>
                                        <div style="font-size: 12px; color: #666;">Costo totale</div>
                                    </div>
                                    <div>
                                        📊 <strong>${(vehicle.trips.reduce((sum, t) => sum + t.fuel, 0) / vehicle.trips.reduce((sum, t) => sum + t.kmDifference, 0) * 100).toFixed(1)} L/100km</strong>
                                        <div style="font-size: 12px; color: #666;">Consumo medio</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="createMovement('${vehicle.id}', 'vehicle')">
                            📤 Nuovo Viaggio
                        </button>
                        <button class="btn btn-primary" onclick="editVehicle('${vehicle.id}')">
                            ✏️ Modifica
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        // ============================================
        // EQUIPMENT MOVEMENTS WITH WARNINGS
        // ============================================
        
        function createMovement(itemId, itemType) {
            const item = itemType === 'equipment' 
                ? AppData.equipment.find(e => e.id === itemId)
                : AppData.vehicles.find(v => v.id === itemId);
            
            if (!item) {
                showNotification('Elemento non trovato', 'error');
                return;
            }
            
            // Check if equipment requires warning
            if (itemType === 'equipment' && item.requiresWarning && item.warningMessage) {
                showWarningConfirmation(item, () => {
                    // After acknowledgment, show movement modal
                    showMovementModal(itemId, itemType);
                });
            } else {
                // No warning required, show movement modal directly
                showMovementModal(itemId, itemType);
            }
        }
        
        function showWarningConfirmation(equipment, callback) {
            const modalHtml = `
                <div id="warning-modal" class="modal active">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header" style="background: #e74c3c; color: white;">
                            <h2>⚠️ ATTENZIONE - ${equipment.name}</h2>
                            <button class="close-modal" onclick="closeModal('warning-modal')" style="color: white;">×</button>
                        </div>
                        
                        <div style="padding: 30px;">
                            <div class="alert alert-danger" style="border: 3px solid #e74c3c; background: #ffebee; margin-bottom: 20px;">
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <span style="font-size: 48px;">⚠️</span>
                                    <div style="flex: 1;">
                                        <h3 style="color: #e74c3c; margin-top: 0;">Attrezzatura con Avviso di Sicurezza</h3>
                                        <div style="white-space: pre-wrap; line-height: 1.6; font-size: 16px; color: #333;">
${equipment.warningMessage}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <strong>📋 Prima di procedere, verifica:</strong>
                                <ul style="margin: 10px 0; padding-left: 20px;">
                                    <li>Di avere le competenze necessarie per l'utilizzo</li>
                                    <li>Di aver letto e compreso le istruzioni</li>
                                    <li>Di disporre dei DPI necessari</li>
                                    <li>Che l'attrezzatura sia in buone condizioni</li>
                                </ul>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold;">
                                    <input type="checkbox" id="warning-acknowledged" style="width: 24px; height: 24px;" required>
                                    <span>Ho letto e compreso l'avviso. Confermo di poter utilizzare questa attrezzatura in sicurezza.</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>Il tuo nome (per tracciamento) *</label>
                                <input type="text" id="acknowledger-name" placeholder="Es: Mario Rossi" required>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid #ddd;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('warning-modal')">
                                ❌ Annulla
                            </button>
                            <button type="button" class="btn btn-danger" onclick="acknowledgeWarning('${equipment.id}')">
                                ✅ Ho Capito, Procedi
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Store callback for later
            window.__warningCallback = callback;
        }
        
        function acknowledgeWarning(equipmentId) {
            const acknowledged = document.getElementById('warning-acknowledged').checked;
            const acknowledgerName = document.getElementById('acknowledger-name').value.trim();
            
            if (!acknowledged) {
                showNotification('⚠️ Devi confermare di aver letto l\'avviso', 'error');
                return;
            }
            
            if (!acknowledgerName) {
                showNotification('⚠️ Inserisci il tuo nome', 'error');
                return;
            }
            
            // Log acknowledgment
            const equipment = AppData.equipment.find(e => e.id === equipmentId);
            if (equipment) {
                if (!equipment.warningAcknowledgments) {
                    equipment.warningAcknowledgments = [];
                }
                
                equipment.warningAcknowledgments.push({
                    acknowledger: acknowledgerName,
                    timestamp: new Date().toISOString(),
                    action: 'movement_creation'
                });
                
                saveData();
            }
            
            // Close modal
            closeModal('warning-modal');
            
            // Call the callback to show movement modal
            if (window.__warningCallback) {
                window.__warningCallback();
                window.__warningCallback = null;
            }
            
            showNotification('✅ Avviso confermato', 'success');
        }
        
        function showMovementModal(itemId, itemType) {
            if (itemType === 'vehicle') {
                // For vehicles, show trip tracking modal
                showVehicleTripModal(itemId);
            } else {
                // For equipment, show simple movement modal
                showEquipmentMovementModal(itemId);
            }
        }
        
        // ============================================
        // VEHICLE TRIP TRACKING
        // ============================================
        
        function showVehicleTripModal(vehicleId) {
            const vehicle = AppData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) {
                showNotification('Veicolo non trovato', 'error');
                return;
            }
            
            // Get last trip for km initialization
            const lastTrip = vehicle.trips && vehicle.trips.length > 0 
                ? vehicle.trips[vehicle.trips.length - 1]
                : null;
            const suggestedStartKm = lastTrip ? lastTrip.kmEnd : (vehicle.currentKm || 0);
            
            const modalHtml = `
                <div id="vehicle-trip-modal" class="modal active">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>🚗 Nuovo Viaggio - ${vehicle.plate}</h2>
                            <button class="close-modal" onclick="closeModal('vehicle-trip-modal')">×</button>
                        </div>
                        
                        <form onsubmit="saveVehicleTrip(event, '${vehicleId}')">
                            <div class="alert alert-info">
                                <span>ℹ️</span>
                                <span><strong>${vehicle.brand} ${vehicle.model}</strong> - Ultimo KM registrato: <strong>${suggestedStartKm} km</strong></span>
                            </div>
                            
                            <h3 style="color: #f39c12; margin-top: 20px;">👤 Conducente</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nome Conducente *</label>
                                    <select id="trip-driver" required onchange="toggleOtherDriver()">
                                        <option value="">Seleziona...</option>
                                        ${AppData.workers.map(w => `
                                            <option value="${w.id}">${w.name} ${w.surname}</option>
                                        `).join('')}
                                        <option value="other">📝 Altro conducente...</option>
                                    </select>
                                </div>
                                <div class="form-group" id="other-driver-group" style="display: none;">
                                    <label>Nome Altro Conducente *</label>
                                    <input type="text" id="trip-driver-other" placeholder="Es: Mario Rossi">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Patente</label>
                                    <input type="text" id="trip-license" placeholder="Es: AB123456">
                                </div>
                                <div class="form-group">
                                    <label>Telefono Conducente</label>
                                    <input type="tel" id="trip-phone" placeholder="Es: 333 1234567">
                                </div>
                            </div>
                            
                            <h3 style="color: #f39c12; margin-top: 20px;">📍 Itinerario</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Partenza *</label>
                                    <input type="text" id="trip-from" required placeholder="Es: Magazzino Centrale, Via Roma 1">
                                </div>
                                <div class="form-group">
                                    <label>Destinazione *</label>
                                    <input type="text" id="trip-to" required placeholder="Es: Cantiere Nord, Via Milano 50">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Data/Ora Partenza *</label>
                                    <input type="datetime-local" id="trip-start-time" required>
                                </div>
                                <div class="form-group">
                                    <label>Data/Ora Arrivo Previsto</label>
                                    <input type="datetime-local" id="trip-end-time">
                                </div>
                            </div>
                            
                            <h3 style="color: #f39c12; margin-top: 20px;">🛣️ Chilometri</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>KM Iniziali *</label>
                                    <input type="number" id="trip-km-start" value="${suggestedStartKm}" required step="1" min="0">
                                    <small>Leggere dal contachilometri del veicolo</small>
                                </div>
                                <div class="form-group">
                                    <label>KM Finali *</label>
                                    <input type="number" id="trip-km-end" required step="1" min="${suggestedStartKm}" onchange="calculateKmDifference()">
                                    <small>Compilare al termine del viaggio</small>
                                </div>
                            </div>
                            
                            <div class="alert alert-success" id="km-difference-alert" style="display: none;">
                                <span>📊</span>
                                <span>Distanza percorsa: <strong id="km-difference-value">0</strong> km</span>
                            </div>
                            
                            <h3 style="color: #f39c12; margin-top: 20px;">⛽ Carburante e Costi</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Carburante Utilizzato (litri)</label>
                                    <input type="number" id="trip-fuel" step="0.1" min="0" placeholder="Es: 25.5" onchange="calculateFuelCost()">
                                </div>
                                <div class="form-group">
                                    <label>Prezzo Carburante (€/litro)</label>
                                    <input type="number" id="trip-fuel-price" step="0.01" min="0" value="1.85" placeholder="Es: 1.85" onchange="calculateFuelCost()">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Costo Carburante (€)</label>
                                    <input type="number" id="trip-fuel-cost" step="0.01" min="0" readonly style="background: #f0f0f0;">
                                    <small>Calcolato automaticamente</small>
                                </div>
                                <div class="form-group">
                                    <label>Tipo Carburante</label>
                                    <select id="trip-fuel-type">
                                        <option value="diesel">Diesel</option>
                                        <option value="benzina">Benzina</option>
                                        <option value="metano">Metano</option>
                                        <option value="gpl">GPL</option>
                                        <option value="elettrico">Elettrico</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Pedaggi (€)</label>
                                    <input type="number" id="trip-tolls" step="0.01" min="0" placeholder="0.00" onchange="calculateTotalCost()">
                                </div>
                                <div class="form-group">
                                    <label>Parcheggi (€)</label>
                                    <input type="number" id="trip-parking" step="0.01" min="0" placeholder="0.00" onchange="calculateTotalCost()">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Altri Costi (€)</label>
                                <input type="number" id="trip-other-costs" step="0.01" min="0" placeholder="0.00" onchange="calculateTotalCost()">
                                <small>Es: lavaggio, riparazioni, ecc.</small>
                            </div>
                            
                            <div class="alert alert-warning" id="total-cost-alert">
                                <span>💰</span>
                                <span>Costo Totale Viaggio: <strong id="total-cost-value">€ 0.00</strong></span>
                            </div>
                            
                            <h3 style="color: #f39c12; margin-top: 20px;">📋 Dettagli</h3>
                            <div class="form-group">
                                <label>Motivo del Viaggio *</label>
                                <select id="trip-purpose" required>
                                    <option value="">Seleziona...</option>
                                    <option value="cantiere">Trasferimento a Cantiere</option>
                                    <option value="fornitore">Visita Fornitore</option>
                                    <option value="consegna">Consegna Materiali</option>
                                    <option value="cliente">Visita Cliente</option>
                                    <option value="manutenzione">Manutenzione Mezzo</option>
                                    <option value="altro">Altro</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Carico Trasportato</label>
                                <textarea id="trip-cargo" rows="2" placeholder="Es: Betoniera, 3 sacchi cemento, utensili vari"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Note Viaggio</label>
                                <textarea id="trip-notes" rows="3" placeholder="Note sul viaggio, condizioni meteo, incidenti, ecc."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="trip-completed" style="width: 20px; height: 20px;" onchange="toggleCompletedFields()">
                                    <span>✅ Viaggio completato (compila KM finali e arrivo effettivo)</span>
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('vehicle-trip-modal')">
                                    ❌ Annulla
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    💾 Salva Viaggio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <script>
                    // Initialize datetime to now
                    document.getElementById('trip-start-time').value = new Date().toISOString().slice(0, 16);
                    
                    function toggleOtherDriver() {
                        const select = document.getElementById('trip-driver');
                        const otherGroup = document.getElementById('other-driver-group');
                        const otherInput = document.getElementById('trip-driver-other');
                        
                        if (select.value === 'other') {
                            otherGroup.style.display = 'block';
                            otherInput.required = true;
                        } else {
                            otherGroup.style.display = 'none';
                            otherInput.required = false;
                            otherInput.value = '';
                        }
                    }
                    
                    function calculateKmDifference() {
                        const kmStart = parseFloat(document.getElementById('trip-km-start').value) || 0;
                        const kmEnd = parseFloat(document.getElementById('trip-km-end').value) || 0;
                        const difference = kmEnd - kmStart;
                        
                        if (difference > 0) {
                            document.getElementById('km-difference-value').textContent = difference;
                            document.getElementById('km-difference-alert').style.display = 'flex';
                        } else {
                            document.getElementById('km-difference-alert').style.display = 'none';
                        }
                        
                        calculateTotalCost();
                    }
                    
                    function calculateFuelCost() {
                        const fuel = parseFloat(document.getElementById('trip-fuel').value) || 0;
                        const price = parseFloat(document.getElementById('trip-fuel-price').value) || 0;
                        const cost = fuel * price;
                        
                        document.getElementById('trip-fuel-cost').value = cost.toFixed(2);
                        calculateTotalCost();
                    }
                    
                    function calculateTotalCost() {
                        const fuelCost = parseFloat(document.getElementById('trip-fuel-cost').value) || 0;
                        const tolls = parseFloat(document.getElementById('trip-tolls').value) || 0;
                        const parking = parseFloat(document.getElementById('trip-parking').value) || 0;
                        const otherCosts = parseFloat(document.getElementById('trip-other-costs').value) || 0;
                        
                        const total = fuelCost + tolls + parking + otherCosts;
                        document.getElementById('total-cost-value').textContent = '€ ' + total.toFixed(2);
                    }
                    
                    function toggleCompletedFields() {
                        const completed = document.getElementById('trip-completed').checked;
                        const kmEndField = document.getElementById('trip-km-end');
                        const endTimeField = document.getElementById('trip-end-time');
                        
                        if (completed) {
                            kmEndField.required = true;
                            endTimeField.required = true;
                        } else {
                            kmEndField.required = false;
                            endTimeField.required = false;
                        }
                    }
                    
                    // Trigger initial calculations
                    calculateTotalCost();
                </script>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function saveVehicleTrip(event, vehicleId) {
            event.preventDefault();
            
            const vehicle = AppData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            // Get driver info
            const driverSelect = document.getElementById('trip-driver').value;
            let driverName;
            if (driverSelect === 'other') {
                driverName = document.getElementById('trip-driver-other').value;
            } else {
                const driver = AppData.workers.find(w => w.id === driverSelect);
                driverName = driver ? `${driver.name} ${driver.surname}` : '';
            }
            
            // Calculate values
            const kmStart = parseFloat(document.getElementById('trip-km-start').value) || 0;
            const kmEnd = parseFloat(document.getElementById('trip-km-end').value) || 0;
            const kmDifference = kmEnd - kmStart;
            
            const fuelCost = parseFloat(document.getElementById('trip-fuel-cost').value) || 0;
            const tolls = parseFloat(document.getElementById('trip-tolls').value) || 0;
            const parking = parseFloat(document.getElementById('trip-parking').value) || 0;
            const otherCosts = parseFloat(document.getElementById('trip-other-costs').value) || 0;
            const totalCost = fuelCost + tolls + parking + otherCosts;
            
            const trip = {
                id: generateId('TRIP'),
                vehicleId: vehicleId,
                driver: driverName,
                driverId: driverSelect !== 'other' ? driverSelect : null,
                license: document.getElementById('trip-license').value,
                phone: document.getElementById('trip-phone').value,
                from: document.getElementById('trip-from').value,
                to: document.getElementById('trip-to').value,
                startTime: document.getElementById('trip-start-time').value,
                endTime: document.getElementById('trip-end-time').value,
                kmStart: kmStart,
                kmEnd: kmEnd,
                kmDifference: kmDifference,
                fuel: parseFloat(document.getElementById('trip-fuel').value) || 0,
                fuelPrice: parseFloat(document.getElementById('trip-fuel-price').value) || 0,
                fuelCost: fuelCost,
                fuelType: document.getElementById('trip-fuel-type').value,
                tolls: tolls,
                parking: parking,
                otherCosts: otherCosts,
                totalCost: totalCost,
                purpose: document.getElementById('trip-purpose').value,
                cargo: document.getElementById('trip-cargo').value,
                notes: document.getElementById('trip-notes').value,
                completed: document.getElementById('trip-completed').checked,
                createdAt: new Date().toISOString()
            };
            
            // Initialize trips array if not exists
            if (!vehicle.trips) {
                vehicle.trips = [];
            }
            
            vehicle.trips.push(trip);
            
            // Update vehicle current km
            vehicle.currentKm = kmEnd;
            
            // Update vehicle status
            if (trip.completed) {
                vehicle.status = 'available';
            } else {
                vehicle.status = 'in_use';
            }
            
            saveData();
            
            closeModal('vehicle-trip-modal');
            showNotification('✅ Viaggio registrato con successo!', 'success');
            
            // Offer to print trip sheet
            setTimeout(() => {
                if (confirm('Vuoi stampare il foglio di viaggio?')) {
                    printTripSheet(trip.id, vehicleId);
                } else {
                    renderVehiclesList();
                }
            }, 500);
        }
        
        function printTripSheet(tripId, vehicleId) {
            const vehicle = AppData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle || !vehicle.trips) return;
            
            const trip = vehicle.trips.find(t => t.id === tripId);
            if (!trip) return;
            
            const printWindow = window.open('', '_blank');
            
            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Foglio di Viaggio - ${vehicle.plate}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #f39c12;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        
                        h1 { color: #f39c12; margin: 0 0 10px 0; }
                        h3 { color: #f39c12; margin-top: 0; border-bottom: 1px solid #f39c12; padding-bottom: 5px; }
                        
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                        .info-section { border: 2px solid #ddd; padding: 15px; border-radius: 8px; }
                        
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin: 8px 0;
                            padding: 5px 0;
                            border-bottom: 1px dotted #ddd;
                        }
                        
                        .label { font-weight: bold; color: #666; }
                        .value { color: #333; }
                        
                        .highlight-box {
                            background: #fff3cd;
                            border: 2px solid #f39c12;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 20px 0;
                            text-align: center;
                        }
                        
                        .big-value { font-size: 32px; font-weight: bold; color: #f39c12; }
                        
                        .signature-section {
                            margin-top: 40px;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 40px;
                        }
                        
                        .signature-box {
                            border-top: 2px solid #333;
                            padding-top: 10px;
                            text-align: center;
                        }
                        
                        .print-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #f39c12;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                        }
                        
                        @media print {
                            .print-button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-button" onclick="window.print()">🖨️ Stampa</button>
                    
                    <div class="header">
                        <h1>🚗 FOGLIO DI VIAGGIO</h1>
                        <div style="font-size: 14px; color: #666;">
                            Documento generato il: ${new Date().toLocaleString('it-IT')}
                        </div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-section">
                            <h3>🚗 Veicolo</h3>
                            <div class="info-row">
                                <span class="label">Targa:</span>
                                <span class="value"><strong>${vehicle.plate}</strong></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Marca/Modello:</span>
                                <span class="value">${vehicle.brand} ${vehicle.model}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Tipo:</span>
                                <span class="value">${vehicle.type}</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h3>👤 Conducente</h3>
                            <div class="info-row">
                                <span class="label">Nome:</span>
                                <span class="value"><strong>${trip.driver}</strong></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Patente:</span>
                                <span class="value">${trip.license || 'N/D'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Telefono:</span>
                                <span class="value">${trip.phone || 'N/D'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3>📍 Itinerario</h3>
                        <div class="info-row">
                            <span class="label">Partenza:</span>
                            <span class="value">${trip.from}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Destinazione:</span>
                            <span class="value">${trip.to}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Motivo:</span>
                            <span class="value">${trip.purpose}</span>
                        </div>
                        ${trip.cargo ? `
                            <div class="info-row">
                                <span class="label">Carico:</span>
                                <span class="value">${trip.cargo}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-section">
                            <h3>🕐 Orari</h3>
                            <div class="info-row">
                                <span class="label">Partenza:</span>
                                <span class="value">${new Date(trip.startTime).toLocaleString('it-IT')}</span>
                            </div>
                            ${trip.endTime ? `
                                <div class="info-row">
                                    <span class="label">Arrivo:</span>
                                    <span class="value">${new Date(trip.endTime).toLocaleString('it-IT')}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="info-section">
                            <h3>🛣️ Chilometri</h3>
                            <div class="info-row">
                                <span class="label">KM Iniziali:</span>
                                <span class="value">${trip.kmStart} km</span>
                            </div>
                            <div class="info-row">
                                <span class="label">KM Finali:</span>
                                <span class="value">${trip.kmEnd} km</span>
                            </div>
                            <div class="info-row" style="background: #f0f0f0; margin: 5px -10px; padding: 5px 10px;">
                                <span class="label">Percorsi:</span>
                                <span class="value"><strong>${trip.kmDifference} km</strong></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section" style="margin: 20px 0;">
                        <h3>⛽ Carburante e Costi</h3>
                        <div class="info-row">
                            <span class="label">Carburante (${trip.fuelType}):</span>
                            <span class="value">${trip.fuel} litri × € ${trip.fuelPrice.toFixed(2)} = <strong>€ ${trip.fuelCost.toFixed(2)}</strong></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Pedaggi:</span>
                            <span class="value">€ ${trip.tolls.toFixed(2)}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Parcheggi:</span>
                            <span class="value">€ ${trip.parking.toFixed(2)}</span>
                        </div>
                        ${trip.otherCosts > 0 ? `
                            <div class="info-row">
                                <span class="label">Altri costi:</span>
                                <span class="value">€ ${trip.otherCosts.toFixed(2)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="highlight-box">
                        <div style="font-size: 18px; margin-bottom: 10px;">💰 COSTO TOTALE VIAGGIO</div>
                        <div class="big-value">€ ${trip.totalCost.toFixed(2)}</div>
                    </div>
                    
                    ${trip.notes ? `
                        <div class="info-section">
                            <h3>📋 Note</h3>
                            <p style="white-space: pre-wrap;">${trip.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="signature-section">
                        <div class="signature-box">
                            <div style="margin-bottom: 50px;"></div>
                            <div><strong>Firma Conducente</strong></div>
                            <div style="font-size: 12px; color: #666;">${trip.driver}</div>
                        </div>
                        <div class="signature-box">
                            <div style="margin-bottom: 50px;"></div>
                            <div><strong>Firma Responsabile</strong></div>
                            <div style="font-size: 12px; color: #666;">Verifica e Autorizzazione</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px;">
                        <p><strong>Gestionale Impresa Edile Pro</strong> - ID Viaggio: ${trip.id}</p>
                        <p>Questo documento ha valore fiscale e deve essere conservato secondo normativa vigente</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printHtml);
            printWindow.document.close();
            
            showNotification('✅ Foglio di viaggio pronto per la stampa!', 'success');
        }
        
        function printVehicleTripsReport(vehicleId) {
            const vehicle = AppData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle || !vehicle.trips || vehicle.trips.length === 0) {
                showNotification('❌ Nessun viaggio registrato', 'error');
                return;
            }
            
            const totalKm = vehicle.trips.reduce((sum, t) => sum + t.kmDifference, 0);
            const totalFuel = vehicle.trips.reduce((sum, t) => sum + t.fuel, 0);
            const totalCost = vehicle.trips.reduce((sum, t) => sum + t.totalCost, 0);
            const avgConsumption = totalKm > 0 ? (totalFuel / totalKm * 100) : 0;
            
            const printWindow = window.open('', '_blank');
            
            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Report Viaggi - ${vehicle.plate}</title>
                    <style>
                        @media print {
                            @page { margin: 1.5cm; }
                            body { margin: 0; }
                        }
                        
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
                        
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #f39c12;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        
                        h1 { color: #f39c12; margin: 0 0 10px 0; }
                        
                        .summary {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 30px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                        }
                        
                        .summary-item {
                            text-align: center;
                        }
                        
                        .summary-item .value {
                            font-size: 32px;
                            font-weight: bold;
                        }
                        
                        .summary-item .label {
                            font-size: 14px;
                            opacity: 0.9;
                            margin-top: 5px;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        
                        th {
                            background: #f39c12;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                        }
                        
                        td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        tr:hover {
                            background: #f8f9fa;
                        }
                        
                        .badge {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        
                        .badge-success { background: #2ecc71; color: white; }
                        .badge-warning { background: #f1c40f; color: #333; }
                        
                        .print-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #f39c12;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                        }
                        
                        @media print {
                            .print-button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-button" onclick="window.print()">🖨️ Stampa</button>
                    
                    <div class="header">
                        <h1>📊 Report Viaggi - ${vehicle.plate}</h1>
                        <div style="font-size: 16px; margin-top: 10px;">
                            ${vehicle.brand} ${vehicle.model} - ${vehicle.type}
                        </div>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                            Generato il: ${new Date().toLocaleDateString('it-IT', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <div class="value">${vehicle.trips.length}</div>
                            <div class="label">Viaggi Totali</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${totalKm.toLocaleString()}</div>
                            <div class="label">KM Percorsi</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${totalFuel.toFixed(1)}</div>
                            <div class="label">Litri Carburante</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">€ ${totalCost.toFixed(2)}</div>
                            <div class="label">Costo Totale</div>
                        </div>
                        <div class="summary-item">
                            <div class="value">${avgConsumption.toFixed(1)}</div>
                            <div class="label">L/100km Medio</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Conducente</th>
                                <th>Itinerario</th>
                                <th>KM</th>
                                <th>Carburante</th>
                                <th>Costo</th>
                                <th>Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vehicle.trips.map(trip => `
                                <tr>
                                    <td>${new Date(trip.startTime).toLocaleDateString('it-IT')}</td>
                                    <td>${trip.driver}</td>
                                    <td>
                                        <strong>${trip.from}</strong><br>
                                        → ${trip.to}
                                    </td>
                                    <td>${trip.kmDifference} km</td>
                                    <td>${trip.fuel} L (${trip.fuelType})</td>
                                    <td>€ ${trip.totalCost.toFixed(2)}</td>
                                    <td>
                                        <span class="badge badge-${trip.completed ? 'success' : 'warning'}">
                                            ${trip.completed ? '✅ Completato' : '🚗 In corso'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px;">
                        <p><strong>Gestionale Impresa Edile Pro</strong></p>
                        <p>Report Viaggi - ${vehicle.plate} - ${vehicle.trips.length} viaggi registrati</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printHtml);
            printWindow.document.close();
            
            showNotification('✅ Report viaggi pronto!', 'success');
        }
        
        function showEquipmentMovementModal(equipmentId) {
            // Simple equipment movement
            showNotification('📤 Funzionalità movimentazione attrezzature in sviluppo', 'success');
            
            // In a real implementation, this would show a modal to:
            // - Select destination (site, warehouse, worker)
            // - Add notes
            // - Set return date if temporary
            // - Save the movement record
        }

        // ============================================
        // SITES
        // ============================================
        function renderSitesList() {
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>🏗️ Cantieri</h2>
                        <button class="btn btn-primary" onclick="showAddSiteModal()">
                            ➕ Aggiungi
                        </button>
                    </div>
                    
                    ${AppData.sites.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">🏗️</div>
                            <p>Nessun cantiere inserito</p>
                            <button class="btn btn-primary" onclick="showAddSiteModal()">
                                ➕ Aggiungi Primo Cantiere
                            </button>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Cliente</th>
                                        <th>Budget</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${AppData.sites.map(s => `
                                        <tr>
                                            <td>
                                                <strong>${s.name}</strong><br>
                                                <small>${s.address || ''}</small>
                                            </td>
                                            <td>${s.client || '-'}</td>
                                            <td>${formatCurrency(s.budget)}</td>
                                            <td>
                                                <span class="badge badge-${s.status === 'active' ? 'success' : 'secondary'}">
                                                    ${s.status === 'active' ? '🟢 Attivo' : '⚫ Completato'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-secondary" onclick="viewSiteDetails('${s.id}')">
                                                    👁️ Vedi
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        function showAddSiteModal() {
            const modalHtml = `
                <div id="add-site-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>➕ Nuovo Cantiere</h2>
                            <button class="close-modal" onclick="closeModal('add-site-modal')">×</button>
                        </div>
                        <form onsubmit="saveSite(event)">
                            <div class="form-group">
                                <label>Nome Cantiere *</label>
                                <input type="text" id="s-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Indirizzo</label>
                                <input type="text" id="s-address">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Cliente</label>
                                    <input type="text" id="s-client">
                                </div>
                                <div class="form-group">
                                    <label>Telefono Cliente</label>
                                    <input type="tel" id="s-client-phone">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Budget (€)</label>
                                    <input type="number" id="s-budget" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Categoria</label>
                                    <select id="s-category">
                                        <option value="">Seleziona...</option>
                                        ${AppData.settings.categories.sites.map(cat => `
                                            <option value="${cat}">${cat}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Data Inizio</label>
                                    <input type="date" id="s-start-date">
                                </div>
                                <div class="form-group">
                                    <label>Data Fine Prevista</label>
                                    <input type="date" id="s-end-date">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="s-notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('add-site-modal')">
                                    Annulla
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    💾 Salva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveSite(event) {
            event.preventDefault();
            
            const site = {
                id: generateId('SITE'),
                name: document.getElementById('s-name').value,
                address: document.getElementById('s-address').value,
                client: document.getElementById('s-client').value,
                clientPhone: document.getElementById('s-client-phone').value,
                budget: parseFloat(document.getElementById('s-budget').value) || 0,
                category: document.getElementById('s-category').value,
                startDate: document.getElementById('s-start-date').value,
                endDate: document.getElementById('s-end-date').value,
                notes: document.getElementById('s-notes').value,
                status: 'active',
                progress: 0,
                costs: 0,
                createdAt: new Date().toISOString(),
                photos: [],
                milestones: []
            };
            
            AppData.sites.push(site);
            saveData();
            
            closeModal('add-site-modal');
            showNotification('✅ Cantiere aggiunto con successo!');
            renderSitesList();
        }

        function viewSiteDetails(id) {
            const site = AppData.sites.find(s => s.id === id);
            if (!site) {
                showNotification('Cantiere non trovato', 'error');
                return;
            }
            
            const margin = site.budget - site.costs;
            const marginPercent = site.budget > 0 ? ((margin / site.budget) * 100).toFixed(1) : 0;
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>🏗️ ${site.name}</h2>
                        <button class="btn btn-sm btn-secondary" onclick="renderSitesList()">
                            ← Indietro
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Indirizzo:</strong><br>
                            ${site.address || '-'}
                        </div>
                        <div>
                            <strong>Cliente:</strong><br>
                            ${site.client || '-'}<br>
                            <small>${site.clientPhone || ''}</small>
                        </div>
                        <div>
                            <strong>Categoria:</strong><br>
                            ${site.category || '-'}
                        </div>
                        <div>
                            <strong>Stato:</strong><br>
                            <span class="badge badge-${site.status === 'active' ? 'success' : 'secondary'}">
                                ${site.status === 'active' ? '🟢 Attivo' : '⚫ Completato'}
                            </span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                            <h3>Budget</h3>
                            <div class="value">${formatCurrency(site.budget)}</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
                            <h3>Costi</h3>
                            <div class="value">${formatCurrency(site.costs)}</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, ${margin >= 0 ? '#2ecc71' : '#e74c3c'} 0%, ${margin >= 0 ? '#27ae60' : '#c0392b'} 100%);">
                            <h3>Margine</h3>
                            <div class="value">${formatCurrency(margin)}</div>
                            <div class="label">${marginPercent}%</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                            <h3>Avanzamento</h3>
                            <div class="value">${site.progress}%</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <strong>Periodo:</strong><br>
                        ${formatDate(site.startDate)} → ${formatDate(site.endDate)}
                    </div>
                    
                    ${site.notes ? `
                        <div style="margin-top: 20px;">
                            <strong>Note:</strong><br>
                            <p>${site.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="editSite('${site.id}')">
                            ✏️ Modifica
                        </button>
                        <button class="btn btn-success" onclick="updateSiteProgress('${site.id}')">
                            📊 Aggiorna Avanzamento
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        // ============================================
        // WORKERS
        // ============================================
        function renderWorkersList() {
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>👷 Dipendenti</h2>
                        <button class="btn btn-primary" onclick="showAddWorkerModal()">
                            ➕ Aggiungi
                        </button>
                    </div>
                    
                    ${AppData.workers.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">👷</div>
                            <p>Nessun dipendente inserito</p>
                            <button class="btn btn-primary" onclick="showAddWorkerModal()">
                                ➕ Aggiungi Primo Dipendente
                            </button>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Ruolo</th>
                                        <th>Telefono</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${AppData.workers.map(w => `
                                        <tr>
                                            <td><strong>${w.name}</strong></td>
                                            <td>${w.role || '-'}</td>
                                            <td>${w.phone || '-'}</td>
                                            <td>
                                                <span class="badge badge-${w.status === 'active' ? 'success' : 'secondary'}">
                                                    ${w.status === 'active' ? '🟢 Attivo' : '⚫ Inattivo'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-secondary" onclick="viewWorkerDetails('${w.id}')">
                                                    👁️ Vedi
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        function showAddWorkerModal() {
            const modalHtml = `
                <div id="add-worker-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>➕ Nuovo Dipendente</h2>
                            <button class="close-modal" onclick="closeModal('add-worker-modal')">×</button>
                        </div>
                        <form onsubmit="saveWorker(event)">
                            <div class="form-group">
                                <label>Nome Completo *</label>
                                <input type="text" id="w-name" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ruolo</label>
                                    <input type="text" id="w-role" placeholder="es. Operaio">
                                </div>
                                <div class="form-group">
                                    <label>Telefono</label>
                                    <input type="tel" id="w-phone">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="w-email">
                                </div>
                                <div class="form-group">
                                    <label>Data Assunzione</label>
                                    <input type="date" id="w-hire-date">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Indirizzo</label>
                                <input type="text" id="w-address">
                            </div>
                            
                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="w-notes"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal('add-worker-modal')">
                                    Annulla
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    💾 Salva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveWorker(event) {
            event.preventDefault();
            
            const worker = {
                id: generateId('WRK'),
                name: document.getElementById('w-name').value,
                role: document.getElementById('w-role').value,
                phone: document.getElementById('w-phone').value,
                email: document.getElementById('w-email').value,
                address: document.getElementById('w-address').value,
                hireDate: document.getElementById('w-hire-date').value,
                notes: document.getElementById('w-notes').value,
                status: 'active',
                createdAt: new Date().toISOString(),
                certifications: [],
                ppe: []
            };
            
            AppData.workers.push(worker);
            saveData();
            
            closeModal('add-worker-modal');
            showNotification('✅ Dipendente aggiunto con successo!');
            renderWorkersList();
        }

        function viewWorkerDetails(id) {
            const worker = AppData.workers.find(w => w.id === id);
            if (!worker) {
                showNotification('Dipendente non trovato', 'error');
                return;
            }
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h2>👷 ${worker.name}</h2>
                        <button class="btn btn-sm btn-secondary" onclick="renderWorkersList()">
                            ← Indietro
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Ruolo:</strong><br>
                            ${worker.role || '-'}
                        </div>
                        <div>
                            <strong>Telefono:</strong><br>
                            ${worker.phone || '-'}
                        </div>
                        <div>
                            <strong>Email:</strong><br>
                            ${worker.email || '-'}
                        </div>
                        <div>
                            <strong>Data Assunzione:</strong><br>
                            ${formatDate(worker.hireDate)}
                        </div>
                        <div>
                            <strong>Indirizzo:</strong><br>
                            ${worker.address || '-'}
                        </div>
                        <div>
                            <strong>Stato:</strong><br>
                            <span class="badge badge-${worker.status === 'active' ? 'success' : 'secondary'}">
                                ${worker.status === 'active' ? '🟢 Attivo' : '⚫ Inattivo'}
                            </span>
                        </div>
                    </div>
                    
                    ${worker.notes ? `
                        <div style="margin-top: 20px;">
                            <strong>Note:</strong><br>
                            <p>${worker.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="editWorker('${worker.id}')">
                            ✏️ Modifica
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function showQuickActions() {
            const modalHtml = `
                <div id="quick-actions-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>⚡ Azioni Rapide</h2>
                            <button class="close-modal" onclick="closeModal('quick-actions-modal')">×</button>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <button class="btn btn-primary" onclick="closeModal('quick-actions-modal'); showAddEquipmentModal();">
                                📦 Nuova Attrezzatura
                            </button>
                            <button class="btn btn-primary" onclick="closeModal('quick-actions-modal'); showAddVehicleModal();">
                                🚗 Nuovo Mezzo
                            </button>
                            <button class="btn btn-primary" onclick="closeModal('quick-actions-modal'); showAddSiteModal();">
                                🏗️ Nuovo Cantiere
                            </button>
                            <button class="btn btn-primary" onclick="closeModal('quick-actions-modal'); showAddWorkerModal();">
                                👷 Nuovo Dipendente
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('quick-actions-modal'); showScanner();">
                                📷 Scansiona QR
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // ============================================
        // GOOGLE DRIVE INTEGRATION
        // ============================================
        
        function isGoogleDriveConnected() {
            return localStorage.getItem('googleDriveToken') !== null;
        }
        
        function connectGoogleDrive() {
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                showGoogleDriveSetupGuide();
                return;
            }
            
            // Initialize Google API
            if (!gapiInited || !gisInited) {
                showNotification('Caricamento Google Drive...', 'success');
                initializeGoogleDrive();
                return;
            }
            
            // Request access token
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showNotification('Errore connessione Google Drive', 'error');
                    return;
                }
                
                localStorage.setItem('googleDriveToken', resp.access_token);
                updateGoogleDriveStatus();
                showNotification('✅ Google Drive connesso!');
                syncToGoogleDrive();
            };
            
            if (localStorage.getItem('googleDriveToken') === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function initializeGoogleDrive() {
            // Load Google API scripts
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            document.head.appendChild(gapiScript);
            
            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.onload = gisLoaded;
            document.head.appendChild(gisScript);
        }
        
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: [GOOGLE_DISCOVERY_DOC],
                });
                gapiInited = true;
                maybeEnableGoogleDrive();
            });
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableGoogleDrive();
        }
        
        function maybeEnableGoogleDrive() {
            if (gapiInited && gisInited) {
                showNotification('Google Drive pronto!', 'success');
            }
        }
        
        async function syncToGoogleDrive() {
            if (!isGoogleDriveConnected()) return;
            
            const token = localStorage.getItem('googleDriveToken');
            if (!token) return;
            
            gapi.client.setToken({access_token: token});
            
            const data = JSON.stringify(AppData, null, 2);
            const fileName = 'gestionale-backup.json';
            
            try {
                // Search for existing file
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                
                const files = response.result.files;
                const metadata = {
                    name: fileName,
                    mimeType: 'application/json',
                };
                
                const file = new Blob([data], {type: 'application/json'});
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                formData.append('file', file);
                
                let uploadUrl;
                if (files && files.length > 0) {
                    // Update existing file
                    uploadUrl = `https://www.googleapis.com/upload/drive/v3/files/${files[0].id}?uploadType=multipart`;
                } else {
                    // Create new file
                    uploadUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
                }
                
                const uploadResponse = await fetch(uploadUrl, {
                    method: files && files.length > 0 ? 'PATCH' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData,
                });
                
                if (uploadResponse.ok) {
                    console.log('✅ Sincronizzato su Google Drive');
                } else {
                    console.error('❌ Errore sync Google Drive:', uploadResponse.status);
                }
            } catch (error) {
                console.error('❌ Errore sync Google Drive:', error);
            }
        }
        
        function updateGoogleDriveStatus() {
            const statusDiv = document.getElementById('google-drive-status');
            const statusText = document.getElementById('google-drive-status-text');
            
            if (isGoogleDriveConnected()) {
                statusDiv.className = 'dropbox-status connected';
                statusText.textContent = 'Connesso';
                statusDiv.onclick = null;
            } else {
                statusDiv.className = 'dropbox-status disconnected';
                statusText.textContent = 'Google Drive';
                statusDiv.style.cursor = 'pointer';
                statusDiv.onclick = connectGoogleDrive;
            }
        }
        
        function showGoogleDriveSetupGuide() {
            const modalHtml = `
                <div id="google-setup-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>🔧 Setup Google Drive</h2>
                            <button class="close-modal" onclick="closeModal('google-setup-modal')">×</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="alert alert-warning">
                                <span>⚠️</span>
                                <span><strong>CONFIGURAZIONE NECESSARIA</strong></span>
                            </div>
                            
                            <h3>📝 Procedura Semplice:</h3>
                            <ol style="line-height: 2;">
                                <li>Vai su: <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                                <li>Crea nuovo progetto: "Gestionale"</li>
                                <li>Abilita Google Drive API</li>
                                <li>Crea credenziali OAuth 2.0</li>
                                <li>Copia Client ID</li>
                                <li>Modifica file HTML con Client ID</li>
                                <li>Ri-carica su Netlify</li>
                            </ol>
                            
                            <p><strong>✅ MOLTO PIÙ SEMPLICE DI DROPBOX!</strong></p>
                            <p>Non servono Redirect URI complicati!</p>
                            
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="window.open('https://console.cloud.google.com/', '_blank')">
                                    🚀 Apri Google Console
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function showGoogleDriveConfig() {
            const modalHtml = `
                <div id="google-config-modal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>📖 Guida Google Drive</h2>
                            <button class="close-modal" onclick="closeModal('google-config-modal')">×</button>
                        </div>
                        <div style="padding: 20px;">
                            <h3>🎯 Setup Veloce (5 minuti)</h3>
                            
                            <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <h4>Passo 1: Crea Progetto Google</h4>
                                <ol>
                                    <li>Vai su <a href="https://console.cloud.google.com/" target="_blank">console.cloud.google.com</a></li>
                                    <li>Clicca "Crea Progetto"</li>
                                    <li>Nome: "Gestionale Impresa"</li>
                                    <li>Clicca "Crea"</li>
                                </ol>
                            </div>
                            
                            <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <h4>Passo 2: Abilita Drive API</h4>
                                <ol>
                                    <li>Nel progetto → "Abilita API e servizi"</li>
                                    <li>Cerca "Google Drive API"</li>
                                    <li>Clicca "Abilita"</li>
                                </ol>
                            </div>
                            
                            <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <h4>Passo 3: Crea Credenziali</h4>
                                <ol>
                                    <li>"Credenziali" → "Crea credenziali"</li>
                                    <li>Scegli "ID client OAuth"</li>
                                    <li>Tipo: "Applicazione web"</li>
                                    <li>✅ FATTO! Copia Client ID</li>
                                </ol>
                            </div>
                            
                            <p style="margin-top: 20px;"><strong>Poi segui le istruzioni nel PDF!</strong></p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Sync every 2 minutes if connected
        setInterval(() => {
            if (isGoogleDriveConnected()) {
                syncToGoogleDrive();
            }
        }, 120000);

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Gestionale Impresa Edile Pro v1.0');
            
            // Load data
            loadData();
            
            // Update Google Drive status
            updateGoogleDriveStatus();
            
            // Render dashboard
            renderDashboard();
            
            // Auto-save every 30 seconds
            setInterval(saveData, 30000);
        });

        // Prevent accidental page leave
        window.addEventListener('beforeunload', (e) => {
            saveData();
        });
    </script>
</body>
</html>
